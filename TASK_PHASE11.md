# Задача: AI Chat Platform — Фаза 11 (Advanced SaaS & Производительность)

## Контекст проекта

Проект ai-chat-lend успешно трансформирован в multi-tenant SaaS-платформу. Реализованы базовые функции чата, воронка расчёта сметы, PDF-генерация, RAG (база знаний), перехват диалога оператором (human takeover) и лимитирование ресурсов по тарифам.

## Что уже сделано (Фазы 5-10)

### Backend (Node.js/Fastify/Postgres)
1. **Multi-tenancy**: Полная изоляция данных через `tenant_id` и `tenantResolver`.
2. **AI Core**: Интеграция с RouterAI (GPT-4o/Claude), RAG-фильтрация через Qdrant.
3. **Integrations**: Telegram (уведомления), amoCRM (сбор лидов с маппингом полей), Yandex Metrika (цели).
4. **Billing Logic**: Система лимитов в `limitsService.ts` (сессии, сообщения, токены) и учёт потребления в `tenant_usage`.
5. **PDF Engine**: Генератор смет через Puppeteer.

### Frontend (React/Zustand/Tailwind)
1. **Chat Core**: Динамическая воронка, выбор сегментов, сбор контактов.
2. **Admin Panel**: Дашборд с воронкой конверсии, управление базой знаний, настройка интеграций.
3. **Billing UI**: Вкладка биллинга с визуализацией использования ресурсов и сравнением тарифов.
4. **Branding**: Динамическая подгрузка цветов, логотипов и текстов тенанта.

## Цели Фазы 11: v2.0 Production Ready

### 1. Переход на облачное хранилище (S3)
Текущие файлы (PDF, аватары) хранятся локально. Нужно интегрировать **Timeweb Cloud S3** (S3-compatible storage):
- [ ] Сервис `s3Service.ts` для загрузки/удаления файлов.
- [ ] Загрузка PDF-смет после генерации в S3.
- [ ] Возможность загрузки аватара бота и логотипа компании в админке.

### 2. Оплата по счёту (B2B Billing)
Т.к. работа идет с юр.лицами/ИП из РФ, вместо платежного шлюза внедряем систему выставления счетов:
- [ ] **Data Model**: Миграция БД (таблица `invoices`, поле `plan_expires_at` в `tenants`).
- [ ] **PDF Счета**: Генерация PDF-счёта с реквизитами через Puppeteer (шаблон HTML).
- [ ] **Tenant UI**: Форма выбора плана/срока и кнопка "Сформировать счёт", история счетов.
- [ ] **Admin UI**: Список счетов для суперадмина с кнопкой "Отметить оплаченным" (активирует план).
- [ ] **Email notifications**: Уведомления через Nodemailer (SMTP) о новых счетах и окончании подписки (за 7 и 3 дня).
- [ ] **Cron Job**: Ежедневная задача для проверки истекающих планов и даунгрейда до Free.

### 3. "Умный" RAG (Self-learning)
- [ ] В админке: кнопка «Добавить в базу знаний» у сообщений менеджера в деталях диалога.
- [ ] Автоматическая векторизация выбранных пар вопрос-ответ в Qdrant.

### 4. Редактор воронки (Dynamic Funnel)
- [ ] Вынос конфигурации шагов воронки из `funnel.ts` в БД (`tenant_bot_settings`).
- [ ] Интерфейс в админке для включения/выключения необязательных шагов (например, перепланировка, дизайн-проект).

### 5. White-label & Domains (Enterprise)
- [ ] Логика проверки DNS-записей (CNAME/A) для кастомных доменов.
- [ ] Отключение надписи "Powered by AI Max" для тарифа Enterprise.

## Технические требования и ограничения

- **Backend**: JavaScript (Node.js), Fastify, библиотеки `aws-sdk` (для S3 compatible), `pg`.
- **Frontend**: React, Lucide-icons, Framer Motion.
- **Безопасность**: Все S3-ссылки для приватных документов (смет) должны генерироваться как `signed URLs` с коротким сроком жизни.
- **Команды**: 
  - `Set-Location backend; npm run build`
  - `Set-Location frontend; npm run build`
  - **ВАЖНО**: Всегда использовать `Cwd = c:\dev\ai-chat-lend`.

## Порядок выполнения

1. Реализовать `s3Service.ts` и перевести PDF-генератор на S3.
2. Добавить функционал загрузки изображений в `TenantBranding` и `BotSettings`.
3. Реализовать функционал "Добавить в базу" в просмотре диалогов.
4. Создать миграцию для хранения шагов воронки в JSONB и обновить `chatStore`.
5. Интегрировать платежный виджет и webhook.

---
*Документ актуален на: 27.02.2026*
