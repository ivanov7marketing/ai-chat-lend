# Phase 10: Интеграции и Ограничение Ресурсов

- [x] 1. Интеграция с amoCRM (Backend)
  - [ ] Создать [backend/src/services/amocrmService.ts](file:///c:/dev/ai-chat-lend/backend/src/services/amocrmService.ts) с функцией [sendLeadToAmoCRM](file:///c:/dev/ai-chat-lend/backend/src/services/amocrmService.ts#13-108)
  - [ ] Обновить [backend/src/routes/leads.ts](file:///c:/dev/ai-chat-lend/backend/src/routes/leads.ts) для вызова [sendLeadToAmoCRM](file:///c:/dev/ai-chat-lend/backend/src/services/amocrmService.ts#13-108) при новом лиде
  - [ ] Добавить обработчик тестирования amoCRM в `backend/src/routes/tenantAdmin.ts`
- [x] 2. Яндекс Метрика (Frontend)
  - [ ] Загружать скрипт Метрики в [TenantLanding.tsx](file:///c:/dev/ai-chat-lend/frontend/src/pages/tenant/TenantLanding.tsx) на основе `yandexMetrika.counterId`
  - [ ] Добавить триггеры целей в [chatStore.ts](file:///c:/dev/ai-chat-lend/frontend/src/store/chatStore.ts) или `ChatWindow.tsx` (`chat_opened`, `estimate_started`, `estimate_completed`, `lead_created`)
  - [ ] Реализовать проверку флагов `events` перед отправкой целей
- [x] 3. Изоляция Ресурсов и Биллинг (Backend)
  - [ ] Создать [backend/src/services/limitsService.ts](file:///c:/dev/ai-chat-lend/backend/src/services/limitsService.ts) с функцией [checkLimit](file:///c:/dev/ai-chat-lend/backend/src/services/limitsService.ts#4-76)
  - [ ] Внедрить проверку лимита сессий в `backend/src/ws/ws.ts`
  - [ ] Внедрить проверку лимита токенов в [backend/src/services/chatService.ts](file:///c:/dev/ai-chat-lend/backend/src/services/chatService.ts)
  - [ ] Обновлять счетчики `tokens_used` в `tenant_usage` после ответов LLM
- [x] 4. Доработка UI Админки (Frontend)
  - [x] Убедиться, что страница Биллинга (Dashboard/Billing) выводит реальные данные из `tenant_usage`
  - [x] Проверить логику сохранения и тестирования в [Integrations.tsx](file:///c:/dev/ai-chat-lend/frontend/src/pages/admin/Integrations.tsx) (события Метрики, amoCRM)

- [x] 5. Полировка Фазы 10 (Backend/Frontend)
  - [x] Централизовать `PLAN_LIMITS` в отдельный конфиг
  - [x] Добавить проверку `trial_ends_at` в [limitsService.ts](file:///c:/dev/ai-chat-lend/backend/src/services/limitsService.ts)
  - [x] Реаллизовать точный подсчет шагов воронки для Дашборда
  - [x] Проверить и исправить ошибки типизации (lint) в бекенде
