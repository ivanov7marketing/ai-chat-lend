# Фаза 10: Интеграции (amoCRM, Метрика) и Ограничение Ресурсов (v1.3)

## Документация
- `GEMINI.md` — правила генерации кода, стек, структура
- `DESIGN.md` — дизайн-система (цвета, типографика, компоненты, Tailwind-токены)
- `AGENTS.md` — правила для AI-агента (запреты, git workflow)
- `ADMINPANEL.md` — спецификация админ-панели
- `REFACT.md` — полная спецификация multi-tenant трансформации (15 разделов), **ОБЯЗАТЕЛЬНО ПРОЧИТАТЬ ПЕРЕД НАЧАЛОМ РАБОТЫ**

## Контекст (Что уже сделано)
К началу 10-й фазы проект имеет следующую готовность:
1. **Воронка, Расчет и PDF:** Бот ведет по воронке, рассчитывает смету и генерирует красивые PDF-документы (Фаза 7).
2. **RAG и База Знаний:** Бот умеет отвечать на свободные вопросы, обращаясь к загруженной документации тенанта (Фаза 8).
3. **Управление Диалогами (Human Takeover):** Менеджер видит диалоги в реальном времени и может перехватить управление у бота (Фаза 9).
4. **Скелет SaaS Платформы:** Реализована мульти-тенантность, роутинг, авторизация и интерфейсы админки (Интеграции, Биллинг, Брендинг).

Тем не менее, интерфейсы настроек в админке пока оторваны от реальной бизнес-логики бэкенда. Нам необходимо "оживить" отправку лидов в CRM, счетчики веб-аналитики и внедрить контроль лимитов в соответствии с выбранным тарифом.

## Цель Фазы 10
Довести SaaS-платформу до состояния **Production-ready MVP** в части работы с внешними системами и монетизации. Главные цели: подключить amoCRM, Яндекс Метрику и внедрить жесткий контроль лимитов (сессий/токенов), чтобы система корректно отрабатывала ограничения тарифов Free, Pro и Enterprise.

## Основные Задачи

### 1. Интеграция с amoCRM (Backend)
- Создать `backend/src/services/amocrmService.ts`.
- Реализовать функцию `sendLeadToAmoCRM(tenantId, leadData, estimateData)`, которая:
  - Получает `webhookUrl`, `apiKey` и `fieldMapping` из таблицы `tenant_integrations`.
  - Формирует отправной Payload на основе правил маппинга (сопоставление локальных параметров и кастомных полей CRM).
  - Отправляет HTTP POST запрос.
- Интегрировать этот вызов в `backend/src/routes/leads.ts` асинхронно после создания лида, аналогично Telegram уведомлениям.

### 2. Яндекс Метрика (Frontend)
- Обеспечить динамическую загрузку счетчика Яндекс Метрики на странице `TenantLanding.tsx` или внутри `ChatWindow.tsx`, исходя из поля `yandex_metrika_counter_id` для текущего тенанта.
- Реализовать триггеры отправки целей/событий (`window.ym(id, 'reachGoal', target)`):
  - `chat_opened` (при старте сессии).
  - `estimate_started` (при начале воронки).
  - `estimate_completed` (после расчета сметы).
  - `lead_created` (при успешной отправке формы контактов).
- Сверять отправку с флагами активных событий из настроек `yandex_metrika_events`.

### 3. Изоляция Ресурсов и Биллинг (Backend)
- Создать `backend/src/services/limitsService.ts`.
- Реализовать функцию `checkLimit(tenantId, resourceType)`:
  - Определять текущий план (`free`, `pro`, `enterprise`) и проверять, не истек ли `trial_ends_at`.
  - Сверять `tenant_usage` (за текущий месяц) с жестко заданными лимитами тарифа (например, 50 сессий для Free).
- Интегрировать проверки:
  - В `ws.ts` (при попытке открыть новый чат). Если лимит исчерпан, возвращать ошибку или специальный системный виджет "Лимит исчерпан".
  - В `chatService.ts` (LLM запросы). Если лимит токенов RouterAI от платформы превышен (для Free тенантов), переключать в fallback или прерывать работу.

### 4. Доработка UI Админки (Frontend)
- Связать страницу `TenantBilling.tsx` (или `PlatformBilling.tsx`) с реальными данными из БД: выводить текущий израсходованный лимит сессий и метрики из `tenant_usage`.
- Обеспечить корректное отображение кнопки "Проверить" (Test Integration) на вкладке Интеграций (`Integrations.tsx`), чтобы она реально дергала тестовый ендпоинт на бэкенде.

---
*Сохраните данный файл как контекст для следующей сессии с AI Агентом.*
