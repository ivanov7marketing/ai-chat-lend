# Задача: AI Chat Lend — Фаза 12 (Human Takeover v2, Analytics & Personalization)

## Контекст проекта
Проект успешно переведен на Multi-Tenant архитектуру. Фаза 11 добавила кастомные воронки, обучение RAG из диалогов и систему биллинга. 
**Фаза 12** фокусируется на "полировке" взаимодействия менеджера с клиентом, глубокой аналитике для тенантов.

## Что уже сделано (Фаза 11 — SaaS Power-up)
- [x] **Изоляция данных**: Полная поддержка `tenant_id` на всех уровнях БД и API.
- [x] **Динамическая воронка**: Редактор вопросов в админке с поддержкой `skipIf` логики.
- [x] **Smart RAG**: Кнопка «Обучить бота» в деталях диалога для быстрого пополнения базы знаний.
- [x] **Биллинг и Email**: Автоматическая генерация счетов (PDF), уведомления об истечении тарифа через Nodemailer.
- [x] **White-label**: Базовая поддержка кастомных доменов и скрытия брендинга платформы.

---

## Что нужно сделать (Фаза 12)

### 1. Human Takeover v2 (Улучшение работы менеджера)

**1.1. Индикаторы печати (Typing Indicators)**
- **Backend**: В `ws/chatHandler.ts` добавить событие `manager_typing`. При получении от админа — транслировать в клиентский сокет.
- **Frontend (Admin)**: При вводе сообщения в `DialogDetail.tsx` отправлять `manager_typing: true` через WS с debounce.
- **Frontend (Client)**: В `chatStore.ts` и `TypingIndicator.tsx` отображать "Менеджер печатает...", когда активен перехват.

**1.2. Шаблоны ответов (Canned Responses)**
- **БД**: Таблица `tenant_canned_responses` (`id`, `tenant_id`, `title`, `content`).
- **Admin UI**: Вкладка в настройках бота для управления шаблонами.
- **Admin Chat**: Кнопка "Слэш-команды" или выпадающий список в `DialogDetail.tsx` для быстрой вставки текста шаблона.

**1.3. Тегирование диалогов (Labels)**
- **БД**: Таблица `dialog_labels` уже есть, но нужно расширить UI.
- **Admin UI**: Возможность вешать цветные теги (Hot, Cold, Finished, Problem) на диалог прямо из списка или деталей.

### 2. Продвинутая аналитика (Advanced Analytics)

**2.1. Funnel Drop-off (Воронка потерь)**
- **Backend**: Метод в `adminService.ts` для подсчета количества ответов на каждом шаге `funnel_steps`.
- **Admin UI**: График (Bar Chart) в Dashboard, показывающий, на каком вопросе пользователи чаще всего закрывают чат.

**2.2. Экспорт лидов в CSV**
- **Backend**: Эндпоинт `GET /api/t/:slug/admin/leads/export`.
- **Service**: Генерация CSV-файла со всеми данными лида (контакты, параметры квартиры, сегмент, дата).
- **Admin UI**: Кнопка на странице диалогов или лидов.

**2.3. Популярность сегментов**
- Круговая диаграмма (Pie Chart) в Dashboard, отображающая распределение выбранных сегментов (Эконом / Комфорт и т.д.).

### 3. Безопасность и Сервис

**3.1. История действий (Audit Log UI)**
- Страница в админке тенанта для просмотра `platform_audit_log` (только по своему `tenant_id`). Кто и когда менял цены, настройки или блокировал диалог.

**3.2. Авто-очистка сессий**
- **Backend**: Крон-задача (`0 4 * * *`), помечающая сессии старше 24ч без активности как `closed`.

---

## Технические требования и ограничения

- **Backend**: Node.js (JavaScript), Fastify, PostgreSQL (pg), WebSocket (ws).
- **Frontend**: React + Tailwind + Lucide Icons.
- **Изоляция**: Все запросы СТРОГО с фильтром по `tenant_id`.
- **Дизайн**: Использовать `DESIGN.md`. Все новые элементы UI (графики, модалы, теги) должны соответствовать общей стилистике.
- **Графики**: Рекомендуется использовать `recharts` (если уже есть) или легкие аналоги.
