# Фаза 9: Управление диалогами и Human Takeover (Перехват оператором)

## Контекст (Что уже сделано)
К моменту начала 9-й фазы проект имеет следующую готовность:
1. **MVP Воронка:** Реализованы все шаги сбора параметров, расчет сметы (по формулам из БД), сбор контактов.
2. **Генерация PDF:** Работает микросервис Puppeteer, формирующий PDF-смету.
3. **Multi-tenant архитектура (v1):** Заложены основы многопользовательской SaaS системы (tenant_id). Поддержка админских роутов.  
4. **База Знаний и `FREE_CHAT` (Фаза 8):** Внедрен векторный поиск через Qdrant. Бот отвечает на свободные вопросы (RAG) на основе загруженных в админке документов, используя RouterAI LLM.

## Цель Фазы 9
Реализовать механизм **Human Takeover** (перехват диалога живым менеджером). Это 핵심-фича для B2B клиентов: менеджер должен видеть переписку бота с клиентом в реальном времени, а при возникновении спорных вопросов или по желанию клиента — "перехватить" чат, приостановив ИИ, и начать отвечать вручную.

## Основные Задачи

### 1. Backend: Обновление схемы БД и сущностей
- Добавить в таблицу `sessions` (или `dialog_labels`) поле `is_human_managed` (boolean, default false), либо ввести статус сессии `HUMAN_TAKEOVER`.
- Убедиться, что таблица `messages` корректно обрабатывает `role = 'manager'` для сообщений от оператора.

### 2. Backend: WebSocket логика (`ws.ts`, `chatService.ts`)
- Реализовать обработку событий от **Админского** WebSocket подключения (сейчас WS работает в основном для виджета клиента).
- Новые WS-эвенты (Admin -> Server):
  - `manager_join_room` — менеджер открыл диалог, подписываем его на обновления сообщений клиента.
  - `manager_takeover` — менеджер нажал "Перехватить". Обновляем БД, блокируем RouterAI для этой сессии.
  - `manager_message` — менеджер отправил текст. Сохраняем в БД, пушим в сокет клиенту `bot_message` (или `manager_message`).
- Блокировка вызовов `ragService.searchKnowledge` / RouterAI, если `is_human_managed == true`.

### 3. Backend: REST API диалогов (`admin.ts` / `dialogService.ts`)
- Оживить эндпоинт `GET /api/t/:slug/admin/dialogs`: возвращать реальный список сессий с пагинацией, фильтрацией по статусу и поиском.
- Оживить эндпоинт `GET /api/t/:slug/admin/dialogs/:id`: возвращать массив всей переписки и данные лида.

### 4. Frontend: Админ-панель (Модули управления чатами)
- Оживить `DialogsList.tsx`: убрать моки, подключить `apiFetch` к бекенду диалогов, отображать реальную статистику.
- Интегрировать интерфейс чата в `DialogDetail.tsx`: 
  - Отображать текущий статус сессии ("Бот общается" / "Оператор в чате").
  - Добавить интерфейс WS-соединения для работы в реальном времени.
  - Поле ввода + кнопка "Отправить" (которая также активирует takeover). 

### 5. Frontend: Клиентский виджет (`frontend/src/store/chatStore.ts`)
- Обработка входящих WS-сообщений от менеджера.
- Изменение индикатора тайпинга, возможно изменение UI-отклика (смена подписи "Макс (ИИ)" на "Имя менеджера").

## Архитектурные нюансы для учета ИИ
У WebSockets сервере Fastify (конкретно `ws.ts`) должна появиться концепция "комнат" (Rooms) по `sessionId`, чтобы Server мог броадкастить сообщение и клиенту (виджет), и админу, который сейчас смотрит детальную страницу этого диалога.

## Ожидаемый результат
Полностью функционирующий раздел "Диалоги" в админ-панели, в котором менеджер может:
- Видеть все чаты.
- Заходить в активный чат и видеть, как бот общается.
- Писать клиенту напрямую, останавливая дальнейшую автогенерацию сообщений от ИИ.
