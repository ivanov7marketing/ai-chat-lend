# Фаза 7: Генерация PDF-смет (v1.1)

## Контекст

MVP (Фазы 1-6) успешно завершён: реализована мультитенантная архитектура, работают лендинги, чат-виджет, сбор лидов, сохранение диалогов и отправка уведомлений в Telegram.

Следующий шаг согласно roadmap (версия v1.1) — **генерация красивых PDF-смет** с помощью Puppeteer и отправка их менеджерам или клиентам в мессенджер. 

Когда пользователь доходит до конца воронки и оставляет контакт (lead_capture), система должна собрать его ответы, сделать точный или ориентировочный расчёт на основе цен тенанта (из `price_matrix`), сгенерировать красивый PDF-документ (с логотипом и брендингом тенанта) и прикрепить его к уведомлению.

## Цели Фазы 7

1. **Создание микросервиса Puppeteer**: Настроить отдельный Docker-контейнер с Puppeteer для рендеринга HTML в PDF (изолирован от основного backend API, чтобы не блокировать event loop).
2. **Backend Engine**: Написать логику генерации красивого HTML-шаблона сметы, используя данные тенанта (`tenant_branding`, `price_matrix`) и параметры квартиры (`apartmentParams`, `selectedSegment`).
3. **Хранение в БД**: Сохранять сгенерированные сметы в таблицу `estimates` (включая `tenant_id`, `session_id`, `result_json`, `pdf_url`).
4. **Интеграция с Telegram**: Отправлять сгенерированный PDF-файл в Telegram (помимо текущего текстового уведомления).

## Структура задач

### Задачи Backend (Основное API)
- [ ] **Сервис генерации HTML (`src/services/pdfTemplateService.ts`)**: 
  - Написать функцию, которая принимает `tenantId`, `apartmentParams`, `selectedSegment` и собирает HTML-разметку.
  - Подставить в HTML цвета (`primary_color`), логотип (`logo_url`) компании и контакты.
  - Детализировать статьи расходов (расчёт по комнатам/работам на основе `price_matrix` для выбранного сегмента).
- [ ] **Клиент к Puppeteer (`src/services/pdfGenerator.ts`)**:
  - Отправка сгенерированного HTML в микросервис Puppeteer по HTTP (например, POST `http://puppeteer:3002/generate`).
  - Получение PDF-буфера (или URL, если Puppeteer сам сохраняет в S3/Volume).
- [ ] **Управление таблицей `estimates`**:
  - Создание `estimateService.ts` с функцией `createEstimate(...)` для сохранения JSON расчёта и пути к PDF в базу данных.
- [ ] **Обновление роута `/api/leads`**:
  - После сохранения лида асинхронно или синхронно запускать генерацию PDF.
  - Обновить `telegramService.ts`, чтобы бот отправлял `sendDocument` с PDF-файлом в чат менеджеру.

### Задачи Docker / Инфраструктура
- [ ] **Директория `/puppeteer`**:
  - Создать `package.json`, `Dockerfile` и минимальный Express/Fastify сервер с подключённым `puppeteer-core` (и браузером Chrome).
  - Настроить 1 эндпоинт: `POST /generate` (принимает HTML строку, возвращает PDF файл).
- [ ] Обновить `docker-compose.yml`:
  - Добавить сервис `puppeteer`.
  - Указать зависимости и healthchecks.

### Задачи Frontend (Опционально на этом этапе)
- [ ] В `chatStore.ts` при переходе в `FREE_CHAT` добавить сообщение от бота: «Смета успешно сформирована! Менеджер скоро пришлёт её вам в [выбранный_мессенджер]» (текст можно сделать настраиваемым).
- [ ] В `TenantDialogDetail.tsx` (в админке) показывать ссылку на сгенерированный PDF, если он привязан к сессии/лиду.

## Технические детали

- **Библиотеки**: Для микросервиса использовать пакеты `puppeteer` (не core, чтобы Chrome ставился автоматом в контейнере) + легковесный HTTP сервер (Express/Fastify).
- **Схема таблицы `estimates`** (уже существует в `REFACT.md`):
  ```sql
  CREATE TABLE estimates (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      session_id UUID REFERENCES sessions(id) ON DELETE CASCADE,
      tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
      params JSONB,
      result_json JSONB,
      pdf_url VARCHAR(500),
      created_at TIMESTAMPTZ DEFAULT NOW()
  );
  ```
- **Стилизация PDF**: Использовать встроенный CSS (или Tailwind через CDN в `head` шаблона) для красивой табличной верстки.

---

*Готов к выполнению? Используй этот файл для запуска новой фазы в следующем диалоге.*
